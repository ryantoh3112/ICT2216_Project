{# templates/payment/cancel.html.twig #}
{% extends 'base.html.twig' %}

{% block body %}
<div class="container mt-5 mb-5 text-center" style="min-height: 70vh;">
  <div class="p-5 bg-light border rounded shadow-sm">
    <h1 class="text-danger mb-3">❌ Payment Canceled</h1>
    <hr>

    <div class="mt-4 text-left mx-auto" style="max-width: 500px;">
      <h4>Order Summary</h4>

      {# 1) group identical ticket types #}
      {% set grouped = {} %}
      {% for item in cartItems %}
        {% set tid = item.ticketType.id %}
        {% if grouped[tid] is not defined %}
          {% set grouped = grouped|merge({
            (tid): {
              name:     item.name,
              unit:     item.price,
              quantity: item.quantity
            }
          }) %}
        {% else %}
          {% set old = grouped[tid] %}
          {% set grouped = grouped|merge({
            (tid): {
              name:     old.name,
              unit:     old.unit,
              quantity: old.quantity + item.quantity
            }
          }) %}
        {% endif %}
      {% endfor %}

      {% if grouped is not empty %}
        {# 2) display each grouped line #}
        {% for info in grouped %}
          <div class="d-flex justify-content-between">
            <span><strong>Product:</strong></span>
            <span>{{ info.name }}</span>
          </div>
          <div class="d-flex justify-content-between">
            <span><strong>Quantity:</strong></span>
            <span>{{ info.quantity }}</span>
          </div>
          <div class="d-flex justify-content-between mb-3">
            <span><strong>Unit Price:</strong></span>
            <span>${{ info.unit|number_format(2, '.', ',') }}</span>
          </div>
        {% endfor %}

        <hr/>

        {# 3) compute totals #}
        {% set subtotal = 0 %}
        {% for info in grouped %}
          {% set subtotal = subtotal + (info.unit * info.quantity) %}
        {% endfor %}
        {% set bookingFee = 3 * (grouped|length) %}
        {% set total = subtotal + bookingFee %}

        <div class="d-flex justify-content-between">
          <span><strong>Subtotal:</strong></span>
          <span>${{ subtotal|number_format(2, '.', ',') }}</span>
        </div>
        <div class="d-flex justify-content-between">
          <span><strong>Booking Fee:</strong></span>
          <span>${{ bookingFee|number_format(2, '.', ',') }}</span>
        </div>
        <hr/>
        <div class="d-flex justify-content-between">
          <span><strong>Total:</strong></span>
          <span><strong>${{ total|number_format(2, '.', ',') }}</strong></span>
        </div>
      {% else %}
        <p class="text-muted">Your cart is empty.</p>
      {% endif %}
    </div>

    <div class="mt-4">
      <a href="{{ path('app_home') }}" class="btn btn-primary me-2">← Return to Home</a>
      <a href="{{ path('checkout_page') }}" class="btn btn-warning">Try Again</a>
    </div>
  </div>
</div>
{% endblock %}
