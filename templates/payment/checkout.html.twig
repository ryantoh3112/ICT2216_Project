{% extends 'base.html.twig' %}

{% block body %}
  <div class="container mt-5 mb-5" style="min-height:70vh">
    <h2 class="text-center mb-4">ðŸ›’ Your Cart</h2>

    {% if items is empty %}
      <p class="text-center text-muted">Your cart is empty.</p>
    {% else %}
      <table class="table table-hover align-middle">
        <thead>
          <tr>
            <th>Item</th>
            <th>Unit Price</th>
            <th style="width:140px">Quantity</th>
            <th>Line Total</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for item in items %}
            <tr>
              <td>{{ item.name }}</td>
              <td>${{ item.price|number_format(2, '.', ',') }}</td>
              <td>
                <form action="{{ path('cart_update', { ticketTypeId: item.id }) }}" method="POST">
                  <select name="quantity" onchange="this.form.submit()"
                          {% if item.avail < 1 %}disabled{% endif %}>
                    {% for i in 1..item.avail %}
                      <option value="{{ i }}" {{ i == item.quantity ? 'selected' }}>{{ i }}</option>
                    {% endfor %}
                  </select>
                  {% if item.avail < 1 %}
                    <div class="text-danger small mt-1">Sold out</div>
                  {% endif %}
                </form>
              </td>
              <td>${{ item.line|number_format(2, '.', ',') }}</td>
              <td>
                <form action="{{ path('cart_remove', { ticketTypeId: item.id }) }}" method="POST"
                onsubmit="return confirm('Remove this item?');">
                  <button class="btn btn-sm btn-outline-danger">Remove</button>
                </form>
              </td>
            </tr>
          {% endfor %}

          {# Totals #}
          <tr>
            <td colspan="3" class="text-end"><strong>Subtotal:</strong></td>
            <td colspan="2">${{ subtotal|number_format(2, '.', ',') }}</td>
          </tr>
          <tr>
            <td colspan="3" class="text-end"><strong>Booking Fee:</strong></td>
            <td colspan="2">${{ booking_fee|number_format(2, '.', ',') }}</td>
          </tr>
          <tr>
            <td colspan="3" class="text-end"><strong>Total:</strong></td>
            <td colspan="2"><strong>${{ total|number_format(2, '.', ',') }}</strong></td>
          </tr>
        </tbody>
      </table>

      <button id="checkout-button" class="btn btn-primary w-100">
        Pay ${{ total|number_format(2, '.', ',') }}
      </button>
    {% endif %}
  </div>

  {% if items is not empty %}
    <script src="https://js.stripe.com/v3/"></script>
    <script>
      const stripe = Stripe('{{ stripe_public_key }}');
      document.getElementById('checkout-button').addEventListener('click', () => {
        fetch("{{ path('create_checkout_session') }}", {
          method: "POST",
          headers: { "Content-Type": "application/json" }
        })
        .then(r => r.json())
        .then(d => stripe.redirectToCheckout({ sessionId: d.id }))
        .catch(e => alert(e));
      });
    </script>
  {% endif %}
{% endblock %}
